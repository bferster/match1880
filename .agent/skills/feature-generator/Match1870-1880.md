# Block matching strategy Skill

## Phase 1: Blocking (Candidate Generation)
Create blocking keys to reduce the comparison space. A pair is a candidate if it shares at least one blocking key.

**Block 1: Phonetic & Demographic**
- Keys: `nysiis_last_name` + `norm_first_name` + `gender` + `race`
- Purpose: Catches straightforward matches with spelling variations.

**Block 2: First Name & Age**
- Keys: `norm_first_name` + `birth_year` (or `birth_year_10`) + `gender` + `race`
- Purpose: Catches people whose last name changed (marriage, adoption, errors).

**Block 3: Last Name & Birth Place**
- Keys: `last_name` + `gender` + `race` + `birth_place` (first 2 chars)
- Purpose: Catches first name variations with distinctive birthplaces.


** PHASE 1 ** { 

** Compensation for common names setup **

Create a function called buildNameFrequencies(dataset)  {	
	It takes an array of person objects (the 1870 dataset). It creates and returns two Map objects (firstNameFreq and lastNameFreq). It iterates through the dataset, normalizes the first_name and last_name (lowercase, trimmed), and counts their occurrences.
	}

Create a function called getNameWeightModifier(name, freqMap) {
	It takes a normalized name and its corresponding frequency map. It returns an integer based on these rules {
	Name missing/not in map: 0
	Count <= 5 (Very Rare): +15
	Count <= 20 (Uncommon): +5
	Count between 21 and 100 (Average): 0
	Count > 100 (Common): -5
	Count > 500 (Extremely Common): -15
	}
 }

For each candidate pair, calculate a  weighted point score {

	**Name match** 

	If full_name is identical in both datasets then add +100 points.
	else if last_name is identical in both datasets and first_name is identical in both datasets {
		If there is no middle_name in both datasets then add +80 points.
		else then add +80 points.
		}
		else if last_name is identical in both datasets and norm_name is identical in both datasets then add +70 points.
		else if last_name is identical AND first_name Jaro-Winkler > 0.8 then add +60 points.
		else if last_name is Identical in both datasets and the first initial of first_name is identical in datasets then add +40 points.
		else if first_name Jaro-Winkler score is â‰¥0.85 then add +20 points. 

	**Compensate for common names**

		If the first_name is matched in the Name_match phase, call the getNameWeightModifier() function for the first_name and add it to the score.
		If the last_name is matched in the Name_match phase, call the getNameWeightModifier() function for the last_name and add it to the score.

	**Birth Year Matches:**

		if birth_year is identical in both datasets then add +50 points  
		else if birth_year +/-2 match in both datasets then add +30 points
		else if birth_year +/-5 match in both datasets then add +5 points

	**Occupation Matches:**

		if norm_occupation match in both datasets then add +10 points

	**Race Match:**

		if race is identical in both datasets then add +10 points
		else if race is B or M in both datasets then add +10 points

	**Penalties (Red Flags):**

		gender mismatch: -500 points
		age regression (1880 birth_year < 1870 birth_year) > 5 years: -20 points
		age regression (1880 birth_year < 1870 birth_year) > 10 years: -100 points
		contradictory birth_place: -50 points
		nysiis_last_name mismatch: -100 points
		nysiis_first_name mismatch: -40 points


} // finished matching candidate in phase 1

	**PHASE 2** {

	** CONFLICT RESOLUTION **

	If multiple 1880 records match same 1870 record: keep highest score, flag others
	If multiple 1870 records match same 1880 record: keep highest score, flag others
	One person can match at most ONE person in the other censu

}

**PHASE 3** {

** HOUSEHOLD CONTEXT BOOSTING **

    Use high-confidence (Tier 1 or Tier 2) matches as "anchors" to help match their household members. Tier 1 is defined as having a score over 100. Tier 2 contains matches with score from 80 to 99.

		1. For each Tier 1 or Tier 2 match, identify their household in both censuses {
			1870: all records with same dwelling number`
			1880: all records with same family number
			}
		2. For unmatched members of these households, add bonus points {
			Head of household name match: +20 points
			Spouse match (opposite gender, similar age): +20 points.
			Child match (using 1880 relation field): +10 points per child, only if they are older than 10 years old.
			Parent match: +15 points.
			Co-residence bonus: +15 points.
			}
		3. Use 1880 relation field to validate family structure {
			"Self" = head of household 
			"Wife" = spouse
			"Son"/"Daughter" = children
			Other relations: Brother, Sister, Father, Mother, Uncle, Aunt, Nephew, Niece, etc.
			}
}

If the boosted score moves the match into a valid Tier, it is added to the results.